name: Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  Get_repo:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Get Source Packages
      id: get_source
      run: |
        # 创建临时构建目录
        TEMP_DIR=$(mktemp -d)
        echo "TEMP_DIR=$TEMP_DIR" >> $GITHUB_ENV
        echo "Using temp directory: $TEMP_DIR"

        # 定义通用克隆函数
        # 参数1: 仓库URL
        # 参数2: 目标文件夹名
        # 参数3: 具体的处理逻辑 (作为字符串传入或并在后台运行)
        
        # 为了提高速度，我们将所有克隆任务放入后台并行运行
        pids=""

        # -------------------------------------------------------------------
        # 任务 1: luci-app-adguardhome (来自当前组织/用户或其他源)
        (
          echo "::group::Downloading luci-app-adguardhome"
          git clone --depth=1 --single-branch https://github.com/ThingsWhy/luci-app-adguardhome.git "$TEMP_DIR/luci-app-adguardhome"
          rm -rf "$TEMP_DIR/luci-app-adguardhome/.git"
          echo "::endgroup::"
        ) &
        pids="$pids $!"

        # -------------------------------------------------------------------
        # 任务 2: ddnsto (来自 nas-packages)
        (
          echo "::group::Downloading ddnsto"
          git clone --depth=1 --single-branch https://github.com/linkease/nas-packages.git "$TEMP_DIR/_nas-packages"
          mkdir -p "$TEMP_DIR/ddnsto"
          cp -R "$TEMP_DIR/_nas-packages/network/services/ddnsto/." "$TEMP_DIR/ddnsto/"
          rm -rf "$TEMP_DIR/_nas-packages"
          echo "::endgroup::"
        ) &
        pids="$pids $!"

        # -------------------------------------------------------------------
        # 任务 3: luci-app-ddnsto (来自 nas-packages-luci)
        (
          echo "::group::Downloading luci-app-ddnsto"
          git clone --depth=1 --single-branch https://github.com/linkease/nas-packages-luci.git "$TEMP_DIR/_nas-packages-luci"
          mkdir -p "$TEMP_DIR/luci-app-ddnsto"
          cp -R "$TEMP_DIR/_nas-packages-luci/luci/luci-app-ddnsto/." "$TEMP_DIR/luci-app-ddnsto/"
          rm -rf "$TEMP_DIR/_nas-packages-luci"
          echo "::endgroup::"
        ) &
        pids="$pids $!"

        # -------------------------------------------------------------------
        # 任务 4: Lucky & luci-app-lucky
        (
          echo "::group::Downloading Lucky"
          git clone --depth=1 --single-branch https://github.com/gdy666/luci-app-lucky.git "$TEMP_DIR/_luci-app-lucky"
          cp -R "$TEMP_DIR/_luci-app-lucky/luci-app-lucky" "$TEMP_DIR/"
          cp -R "$TEMP_DIR/_luci-app-lucky/lucky" "$TEMP_DIR/"
          rm -rf "$TEMP_DIR/_luci-app-lucky"
          echo "::endgroup::"
        ) &
        pids="$pids $!"

        # -------------------------------------------------------------------
        # 任务 5: MosDNS & v2dat
        (
          echo "::group::Downloading MosDNS"
          git clone --depth=1 --single-branch https://github.com/sbwml/luci-app-mosdns.git "$TEMP_DIR/_luci-app-mosdns"
          cp -R "$TEMP_DIR/_luci-app-mosdns/luci-app-mosdns" "$TEMP_DIR/"
          cp -R "$TEMP_DIR/_luci-app-mosdns/v2dat" "$TEMP_DIR/"
          rm -rf "$TEMP_DIR/_luci-app-mosdns"
          echo "::endgroup::"
        ) &
        pids="$pids $!"

        # -------------------------------------------------------------------
        # 任务 6: Aliyundrive-webdav
        (
          echo "::group::Downloading Aliyundrive-webdav"
          git clone --depth=1 --single-branch https://github.com/messense/aliyundrive-webdav.git "$TEMP_DIR/_aliyundrive-webdav"
          cp -R "$TEMP_DIR/_aliyundrive-webdav/openwrt/aliyundrive-webdav" "$TEMP_DIR/"
          cp -R "$TEMP_DIR/_aliyundrive-webdav/openwrt/luci-app-aliyundrive-webdav" "$TEMP_DIR/"
          rm -rf "$TEMP_DIR/_aliyundrive-webdav"
          echo "::endgroup::"
        ) &
        pids="$pids $!"

        # 等待所有后台任务完成
        for pid in $pids; do
          wait $pid || exit 1
        done

        echo "All packages downloaded successfully."
        ls -F "$TEMP_DIR"
      shell: bash

    - name: Sync package folder to upstream repo
      env:
        # 使用上一步生成的 TEMP_DIR 环境变量
        PACKAGE_SOURCE: ${{ env.TEMP_DIR }}
      run: |
        # 配置 Git
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"

        echo "Syncing from $PACKAGE_SOURCE/ to ${GITHUB_WORKSPACE}/"
        
        # 使用 rsync 同步，增加了一些通用的排除项以保持整洁
        rsync -rcl --delete \
          --exclude=".git*" \
          --exclude="README.md" \
          --exclude=".github" \
          --exclude="LICENSE" \
          --exclude=".gitignore" \
          "$PACKAGE_SOURCE/" ./

        # 提交更改
        if ! git diff --quiet || ! git diff --staged --quiet; then
           echo "Changes detected."
           git add .
           git commit -m "Sync packages: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
           git push origin main
        else
           echo "No changes detected."
        fi

    - name: Delete old workflow runs
      if: always() 
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 3
        keep_minimum_runs: 2
