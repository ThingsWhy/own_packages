name: Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  Get_repo:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    - name: Init Building Dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get update -y
        sudo -E apt-get install -y subversion rsync
    - name: Get Source
      run: |
        cd "/home/runner"
        mkdir package && cd package
        svn checkout https://github.com/sbwml/luci-app-alist/trunk/luci-app-alist && rm -rf luci-app-alist/.svn
        git clone https://github.com/kenzok78/luci-app-adguardhome.git && rm -rf luci-app-adguardhome/{.git,root/etc/AdGuardHome.yaml}
    - name: Sync package folder to upstream repo
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        ANOTHER_PACKAGE: /home/runner/package
      run: |
       mkdir -p /home/runner/.ssh
       touch /home/runner/.ssh/known_hosts
       ssh-keyscan github.com >> ~/.ssh/known_hosts
       echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
       chmod 600 ~/.ssh/id_rsa
       cd ${GITHUB_WORKSPACE}
       git config user.email "actions@github.com"
       git config user.name "GitHub Actions"
       rsync -a --delete /home/runner/package/* .
       if [ $? -ne 0 ]; then
         exit 1
       else
         git add .
         git commit -m "Sync package folder from Actions"
         git push origin main
       fi
    - name: CLean
      if: always()
      run: |
       rm -f /home/runner/.ssh/id_rsa
