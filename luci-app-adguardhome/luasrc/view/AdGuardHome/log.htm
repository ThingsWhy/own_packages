{
type: uploaded file
fileName: thingswhy/luci-app-adguardhome/luci-app-adguardhome-31fc2723e209fbdbdc21cc9572c42548fae1474b/luasrc/view/AdGuardHome/log.htm
fullContent:
<%
local uci = require "luci.model.uci".cursor()
local dispatcher = require "luci.dispatcher"
local logfile = uci:get("AdGuardHome","AdGuardHome","logfile") or ""
local can_process_time = (logfile ~= "syslog" and logfile ~= "")
local can_poll = (logfile ~= "")
%>

<div class="cbi-section">
	<div class="cbi-section-node">
		<div class="cbi-value">
			<label class="cbi-value-title" for="reverseCheckbox"><%:reverse%></label>
			<div class="cbi-value-field">
				<input type="checkbox" id="reverseCheckbox" value="reverse" onclick="reverselog()" style="vertical-align:middle;height: auto;" checked />
			</div>
		</div>
		<% if can_process_time then %>
		<div class="cbi-value">
			<label class="cbi-value-title" for="localtimeCheckbox"><%:localtime%></label>
			<div class="cbi-value-field">
				<input type="checkbox" id="localtimeCheckbox" value="localtime" onclick="chlogtime()" style="vertical-align:middle;height: auto;" checked />
			</div>
		</div>
		<% end %>
		<div class="cbi-value cbi-value-last">
			<div class="cbi-value-field">
				<textarea id="logtextarea" class="cbi-input-textarea" style="width: 100%; display:inline" data-update="change" rows="32" cols="60" readonly="readonly"></textarea>
			</div>
		</div>
	</div>
	<div class="cbi-section-create cbi-tblsection-create">
		<input type="button" class="cbi-button cbi-button-apply" id="apply_del_log_button" value="<%:dellog%>" onclick="return apply_del_log()" />
		<input type="button" class="cbi-button cbi-button-apply" value="<%:download log%>" style="display:inline;" onclick="return download_log()" />
	</div>
</div>

<script type="text/javascript">//<![CDATA[
	var logTextarea = document.getElementById('logtextarea');
	var isLogReverse = true;
	var isUtc2Local = <%=tostring(can_process_time)%>;
	var pollActive = false;

	// URLs
	var getLogUrl = '<%=dispatcher.build_url("admin", "services", "AdGuardHome", "getlog")%>';
	var delLogUrl = '<%=dispatcher.build_url("admin", "services", "AdGuardHome", "dodellog")%>';

	// --- Utility Functions ---
	function createAndDownloadFile(fileName, content) {
		var aTag = document.createElement('a');
		var blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
		aTag.download = fileName;
		aTag.href = URL.createObjectURL(blob);
		document.body.appendChild(aTag);
		aTag.click();
		document.body.removeChild(aTag);
		URL.revokeObjectURL(blob);
	}

	function download_log() {
		var dt = new Date();
		var timestamp = (dt.getMonth() + 1) + "-" + dt.getDate() + "-" + dt.getHours() + "_" + dt.getMinutes();
		createAndDownloadFile("AdGuardHome" + timestamp + ".log", logTextarea.value);
		return false; 
	}

	function apply_del_log() {
		L.Request.get(delLogUrl)
			.then(function(response) {
				logTextarea.value = ""; 
			})
			.catch(function(error) {
				console.error("Error deleting log:", error);
				alert("<%:Error deleting log: %>" + error.statusText);
			});
		return false; 
	}

	function p(s) { 
		return s < 10 ? '0' + s : s;
	}

	function convertLineTime(line, toLocal) {
		if (!line || line.length < 19) return line; 
		var dateStr = line.substring(0, 19);
		var restOfLine = line.substring(19);
		var dt;

		if (toLocal) {
			dt = new Date(dateStr.replace(/\//g, '-') + " UTC"); 
			if (dt.toString() === "Invalid Date") return line; 
			return dt.getFullYear() + "/" + p(dt.getMonth() + 1) + "/" + p(dt.getDate()) + " " +
			       p(dt.getHours()) + ":" + p(dt.getMinutes()) + ":" + p(dt.getSeconds()) + restOfLine;
		} else {
			dt = new Date(dateStr.replace(/\//g, '-')); 
			if (dt.toString() === "Invalid Date") return line; 
			return dt.getUTCFullYear() + "/" + p(dt.getUTCMonth() + 1) + "/" + p(dt.getUTCDate()) + " " +
			       p(dt.getUTCHours()) + ":" + p(dt.getUTCMinutes()) + ":" + p(dt.getUTCSeconds()) + restOfLine;
		}
	}

	// --- Log Display Functions ---

	function processNewLogChunk(text) {
		if (!text || text.trim() === "") return ""; 

		var lines = text.trim().split('\n');

		if (isUtc2Local && can_process_time) {
			lines = lines.map(function(line) { return convertLineTime(line, true); });
		}

		return lines.join('\n') + '\n'; 
	}

	function appendLog(processedText) {
		if (isLogReverse) {
			logTextarea.value = processedText + logTextarea.value;
			logTextarea.scrollTop = 0; 
		} else {
			logTextarea.value += processedText;
			logTextarea.scrollTop = logTextarea.scrollHeight; 
		}
	}

	function reverselog() {
		var lines = logTextarea.value.split('\n');
		if (lines.length > 0 && lines[lines.length - 1] === "") {
			lines.pop();
		}
		logTextarea.value = lines.reverse().join('\n');
		if (logTextarea.value !== "") {
			logTextarea.value += '\n';
		}

		isLogReverse = !isLogReverse;
		if (isLogReverse) {
			logTextarea.scrollTop = 0;
		} else {
			logTextarea.scrollTop = logTextarea.scrollHeight;
		}
		// Return true to allow checkbox state change
		return true;
	}

	function chlogtime() {
		isUtc2Local = !isUtc2Local;
		var lines = logTextarea.value.trim().split('\n');
		var convertedLines = lines.map(function(line) {
			return convertLineTime(line, isUtc2Local);
		});
		logTextarea.value = convertedLines.join('\n') + '\n';
		if (isLogReverse) {
			logTextarea.scrollTop = 0;
		} else {
			logTextarea.scrollTop = logTextarea.scrollHeight;
		}
		return true;
	}

	// --- Polling ---
	function handlePollUpdate(response) {
		var processedText = processNewLogChunk(response);
		if (processedText) {
			appendLog(processedText);
		}
	}

	function handlePollError(error) {
		console.error("Log polling error:", error);
		if (!logTextarea.value.includes("<%:Log polling error%>")) {
			appendLog("\n<%:Log polling error.%>");
		}
		// Do not stop polling immediately on network glitches, but maybe throttle?
		// For now, we rely on L.Poll's retry mechanism or user refresh.
	}

	function startPolling() {
		if (pollActive) return;
		pollActive = true;
		L.Poll.add(function() {
			return L.Request.get(getLogUrl)
				.then(function(res) {
					if (res.ok) {
						return res.text();
					} else {
						throw new Error(res.statusText);
					}
				})
				.then(handlePollUpdate);
		}, 3);
	}

	// --- Initial Load ---
	<% if can_poll then %>
		startPolling();
	<% else %>
		logTextarea.value = "<%:Please add log path in config to enable log%>";
	<% end %>

//]]>
</script>
}
