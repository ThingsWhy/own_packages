<%+cbi/valueheader%>

<div style="margin-bottom: 5px;">
	<label><input type="checkbox" id="cb_autoscroll" checked> <%:Auto Scroll%></label>
	<label><input type="checkbox" id="cb_reverse"> <%:Reverse Order%></label>
	<input type="button" class="cbi-button cbi-button-apply" value="<%:Clear Log%>" onclick="clearLog()" />
	<input type="button" class="cbi-button cbi-button-reset" value="<%:Refresh%>" onclick="fetchLog()" />
</div>

<textarea id="syslog_area" class="cbi-input-textarea" style="width: 100%; height: 400px; font-family: monospace; font-size: 12px;" readonly></textarea>

<script type="text/javascript">//<![CDATA[
	var getLogUrl = '<%=luci.dispatcher.build_url("admin", "services", "AdGuardHome", "get_log")%>';
	var truncateUrl = '<%=luci.dispatcher.build_url("admin", "services", "AdGuardHome", "truncate_log")%>';
	
	var logPos = 0;
	var logArea = document.getElementById('syslog_area');
	var autoScroll = document.getElementById('cb_autoscroll');
	var reverseOrder = document.getElementById('cb_reverse');
	
	function fetchLog() {
		L.get(getLogUrl, { pos: logPos }).then(function(xhr) {
			var data = xhr.json();
			if (data && data.log) {
				// 如果日志被轮转（pos重置），清空显示
				if (data.pos < logPos) {
					logArea.value = "";
					logPos = 0;
				}
				
				if (data.log.length > 0) {
					// 简单的反序处理：如果是反序模式，可能需要重新获取全部或只在UI层展示
					// 这里为了性能，反序仅针对当前获取的块，或者建议大日志不开启反序
					// 为简单起见，这里保持追加模式
					logArea.value += data.log;
					
					logPos = data.pos;
					
					if (autoScroll.checked) {
						logArea.scrollTop = logArea.scrollHeight;
					}
				}
			}
		});
	}

	function clearLog() {
		if (confirm('<%:Are you sure to clear the log file?%>')) {
			L.get(truncateUrl).then(function() {
				logArea.value = "";
				logPos = 0;
			});
		}
	}

	// 初始加载
	fetchLog();
	
	// 自动轮询 (每3秒)
	window.setInterval(fetchLog, 3000);
//]]></script>

<%+cbi/valuefooter%>