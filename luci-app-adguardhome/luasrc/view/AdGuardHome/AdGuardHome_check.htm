{
type: uploaded file
fileName: thingswhy/luci-app-adguardhome/luci-app-adguardhome-31fc2723e209fbdbdc21cc9572c42548fae1474b/luasrc/view/AdGuardHome/AdGuardHome_check.htm
fullContent:
<%+cbi/valueheader%>
<%
local fs = require "nixio.fs"
%>
<input type="button" class="cbi-button cbi-button-apply" id="apply_update_button" value="<%:Update core version%>" onclick="return apply_update()" />
<input type="button" class="cbi-button cbi-button-apply" id="apply_forceupdate_button" value="<%:Force update%>" onclick="return apply_forceupdate()" style="display:none" />
<% if self.showfastconfig then %>
<input type="button" class="cbi-button cbi-button-apply" id="to_configpage" value="<%:Fast config%>" onclick="location.href='<%=luci.dispatcher.build_url('admin', 'services', 'AdGuardHome', 'manual')%>'" />
<% end %>
<div id="logview" style="display:none">
	<input type="checkbox" id="reversetag" value="reverse" onclick="reverselog()" style="vertical-align:middle;height: auto;"><%:reverse%></input>
	<textarea id="logtextarea" class="cbi-input-textarea" style="width: 100%;display:block;" data-update="change" rows="5" cols="60" readonly="readonly"></textarea>
</div>
<script type="text/javascript">//<![CDATA[
	var updatebtn = document.getElementById('apply_update_button');
	var forceupdatebtn = document.getElementById('apply_forceupdate_button');
	var logView = document.getElementById('logview');
	var logTextarea = document.getElementById('logtextarea');
	var isLogReverse = false;
	var pollActive = false;

	// URLs for LuCI JS API
	var checkUrl = '<%=luci.dispatcher.build_url("admin", "services", "AdGuardHome", "check")%>';
	var updateUrl = '<%=luci.dispatcher.build_url("admin", "services", "AdGuardHome", "doupdate")%>';

	function reverselog() {
		var lines = logTextarea.value.split('\n');
		logTextarea.value = lines.reverse().join('\n');
		isLogReverse = !isLogReverse;
		if (isLogReverse) {
			logTextarea.scrollTop = 0;
		} else {
			logTextarea.scrollTop = logTextarea.scrollHeight;
		}
		return true; 
	}

	function appendLog(text) {
		if (isLogReverse) {
			logTextarea.value = text + logTextarea.value;
			logTextarea.scrollTop = 0;
		} else {
			logTextarea.value += text;
			logTextarea.scrollTop = logTextarea.scrollHeight;
		}
	}

	function handlePollUpdate(response) {
		if (response && response.trim() !== "") {
			appendLog(response);
		}
	}

	function handlePollError(error) {
		console.error("Polling error:", error);
		appendLog("\n<%:Polling error. Please check network or backend.%>");
		stopPolling(); 
	}

	function handlePollEnd() {
		console.log("Polling finished or timed out.");
		pollActive = false;
		if (updatebtn) { 
			updatebtn.disabled = false;
			updatebtn.value = '<%:Updated%>'; 
		}
		if (forceupdatebtn) {
			forceupdatebtn.style.display = "inline"; 
		}
	}

	function startPolling() {
		if (pollActive) return; 
		logView.style.display = "block";
		pollActive = true;
		
		L.Poll.add(function() {
			return L.Request.get(checkUrl)
				.then(function(res) {
					if (res.ok) {
						return res.text();
					} else {
						throw new Error(res.statusText);
					}
				})
				.then(handlePollUpdate);
		}, 3);
	}

	function stopPolling() {
		// Stop polling via LuCI API not strictly necessary as page refresh clears it,
		// but logical flag update is good.
		pollActive = false;
		handlePollEnd();
	}

	function apply_update_common(force) {
		var params = force ? { force: 1 } : null;
		if (updatebtn) { 
			updatebtn.disabled = true;
			updatebtn.value = '<%:Check...%>';
		}
		if (forceupdatebtn) { 
			forceupdatebtn.style.display = "inline";
		}

		L.Request.get(updateUrl, params)
			.then(function(response) {
				logTextarea.value = ""; 
				appendLog("<%:Update initiated...%>\n");
				startPolling();
			})
			.catch(function(error) {
				console.error("Update initiation error:", error);
				appendLog("\n<%:Error initiating update: %>" + error.statusText);
				if (updatebtn) { 
					updatebtn.disabled = false;
					updatebtn.value = '<%:Update core version%>';
				}
			});
	}

	function apply_update() {
		apply_update_common(false);
		return false;
	}

	function apply_forceupdate() {
		apply_update_common(true);
		return false;
	}

	// Initial check on page load
	<% if fs.access("/var/run/update_core") then %>
		if (updatebtn) { updatebtn.disabled = true; updatebtn.value = '<%:Check...%>'; }
		if (forceupdatebtn) forceupdatebtn.style.display = "inline";
		startPolling();
	<% elseif fs.access("/var/run/update_core_error") then %>
		if (forceupdatebtn) forceupdatebtn.style.display = "inline";
		startPolling();
	<% end %>

//]]>
</script>
}
