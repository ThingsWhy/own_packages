<%+cbi/valueheader%>

<link rel="stylesheet" href="<%=resource%>/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="<%=resource%>/codemirror/theme/dracula.css">
<link rel="stylesheet" href="<%=resource%>/codemirror/addon/fold/foldgutter.css">

<style>
	.CodeMirror { height: 600px; border: 1px solid #ccc; font-size: 13px; }
</style>

<div style="margin-bottom: 5px;">
	<input type="button" class="cbi-button cbi-button-action" value="<%:Load Template%>" onclick="loadTemplate()" />
	<span class="help-icon" title="<%:Load default template with system DNS servers%>"></span>
</div>

<textarea id="code_yaml" name="manual_config" style="display:none"></textarea>

<script src="<%=resource%>/codemirror/lib/codemirror.js"></script>
<script src="<%=resource%>/codemirror/mode/yaml/yaml.js"></script>
<script src="<%=resource%>/codemirror/addon/fold/foldcode.js"></script>
<script src="<%=resource%>/codemirror/addon/fold/foldgutter.js"></script>
<script src="<%=resource%>/codemirror/addon/fold/indent-fold.js"></script>

<script type="text/javascript">//<![CDATA[
	var editor;
	var templateUrl = '<%=luci.dispatcher.build_url("admin", "services", "AdGuardHome", "template")%>';

	// 等待资源加载完成后初始化
	window.addEventListener('load', function() {
		var textArea = document.getElementById('cbid.AdGuardHome.AdGuardHome.manual_config');
		
		if (textArea && typeof CodeMirror !== 'undefined') {
			editor = CodeMirror.fromTextArea(textArea, {
				mode: 'yaml',
				theme: 'dracula',
				lineNumbers: true,
				lineWrapping: true,
				foldGutter: true,
				gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
			});
			
			// 每次按键都更新原 textarea，确保 submit 时能获取到值
			editor.on('change', function(cm) {
				textArea.value = cm.getValue();
			});
		}
	});

	function loadTemplate() {
		if (!confirm('<%:Current config will be overwritten. Continue?%>')) return;
		
		L.get(templateUrl).then(function(xhr) {
			if (editor) {
				editor.setValue(xhr.responseText);
			} else {
				// Fallback if editor failed to load
				var textArea = document.getElementById('cbid.AdGuardHome.AdGuardHome.manual_config');
				if (textArea) textArea.value = xhr.responseText;
			}
		});
	}
//]]></script>

<%+cbi/valuefooter%>